<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeautyAI Real-time Voice Conversation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .status-card.connected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .status-card.disconnected {
            border-color: #f56565;
            background: #fffaf0;
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .recording-indicator {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #fed7d7;
            border-radius: 10px;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .conversation-log {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .message.user {
            background: #bee3f8;
            text-align: right;
        }

        .message.assistant {
            background: #c6f6d5;
        }

        .message.system {
            background: #feebc8;
            font-style: italic;
            text-align: center;
        }

        .settings-panel {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #4a5568;
        }

        .setting-group select,
        .setting-group input {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }

        .audio-player {
            text-align: center;
            margin: 20px 0;
        }

        .audio-player audio {
            width: 100%;
            max-width: 500px;
        }

        .performance-stats {
            background: #edf2f7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            text-align: center;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4299e1;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ BeautyAI Real-time Voice Conversation</h1>
        
        <!-- Connection Status -->
        <div class="status-panel">
            <div class="status-card" id="connection-status">
                <h3>üîó Connection</h3>
                <div id="connection-text">Disconnected</div>
            </div>
            <div class="status-card" id="recording-status">
                <h3>üéôÔ∏è Recording</h3>
                <div id="recording-text">Ready</div>
            </div>
            <div class="status-card" id="processing-status">
                <h3>‚ö° Processing</h3>
                <div id="processing-text">Idle</div>
            </div>
            <div class="status-card" id="models-status">
                <h3>üß† Models</h3>
                <div id="models-text">Not loaded</div>
            </div>
        </div>

        <!-- Voice Controls -->
        <div class="voice-controls">
            <button class="btn btn-primary" id="connect-btn" onclick="connectWebSocket()">
                Connect to BeautyAI
            </button>
            <button class="btn btn-success" id="record-btn" onclick="toggleRecording()" disabled>
                üéôÔ∏è Start Recording
            </button>
            <button class="btn btn-danger" id="stop-btn" onclick="stopRecording()" disabled>
                ‚èπÔ∏è Stop Recording
            </button>
            <button class="btn btn-primary" id="clear-btn" onclick="clearConversation()">
                üóëÔ∏è Clear Chat
            </button>
        </div>

        <!-- Recording Indicator -->
        <div class="recording-indicator" id="recording-indicator">
            <h3>üî¥ Recording in progress...</h3>
            <p>Speak now! Your voice is being captured for processing.</p>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <h3>‚öôÔ∏è Voice Settings</h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="language-select">Language:</label>
                    <select id="language-select">
                        <option value="auto">Auto-detect</option>
                        <option value="ar" selected>Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="voice-select">Voice:</label>
                    <select id="voice-select">
                        <option value="female" selected>Female</option>
                        <option value="male">Male</option>
                        <option value="neutral">Neutral</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="emotion-select">Emotion:</label>
                    <select id="emotion-select">
                        <option value="neutral" selected>Neutral</option>
                        <option value="happy">Happy</option>
                        <option value="professional">Professional</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="speed-range">Speech Speed:</label>
                    <input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.0">
                    <span id="speed-value">1.0x</span>
                </div>
                <div class="setting-group">
                    <label for="preset-select">AI Preset:</label>
                    <select id="preset-select">
                        <option value="qwen_optimized" selected>Qwen Optimized</option>
                        <option value="high_quality">High Quality</option>
                        <option value="speed_optimized">Speed Optimized</option>
                        <option value="creative_optimized">Creative</option>
                        <option value="balanced">Balanced</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="thinking-mode">Thinking Mode:</label>
                    <select id="thinking-mode">
                        <option value="false" selected>Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Performance Stats -->
        <div class="performance-stats" id="performance-stats" style="display: none;">
            <h3>üìä Performance Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="processing-time">0ms</div>
                    <div class="stat-label">Processing Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="audio-size">0KB</div>
                    <div class="stat-label">Audio Size</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="session-messages">0</div>
                    <div class="stat-label">Messages</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="connection-time">0s</div>
                    <div class="stat-label">Connected</div>
                </div>
            </div>
        </div>

        <!-- Audio Player -->
        <div class="audio-player" id="audio-player" style="display: none;">
            <h3>üéµ AI Response</h3>
            <audio controls id="response-audio"></audio>
        </div>

        <!-- Conversation Log -->
        <div class="conversation-log" id="conversation-log">
            <div class="message system">
                Welcome to BeautyAI Real-time Voice Conversation! Click "Connect to BeautyAI" to start.
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let mediaRecorder = null;
        let recordingStream = null;
        let audioChunks = [];
        let isRecording = false;
        let isConnected = false;
        let sessionMessages = 0;
        let connectionStartTime = null;

        // DOM elements
        const connectionStatus = document.getElementById('connection-status');
        const recordingStatus = document.getElementById('recording-status');
        const processingStatus = document.getElementById('processing-status');
        const modelsStatus = document.getElementById('models-status');
        const connectBtn = document.getElementById('connect-btn');
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        const conversationLog = document.getElementById('conversation-log');
        const audioPlayer = document.getElementById('audio-player');
        const responseAudio = document.getElementById('response-audio');
        const performanceStats = document.getElementById('performance-stats');
        const speedRange = document.getElementById('speed-range');
        const speedValue = document.getElementById('speed-value');

        // Update speed display
        speedRange.addEventListener('input', function() {
            speedValue.textContent = this.value + 'x';
        });

        function getWebSocketURL() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            // Use api.gmai.sa for API calls when on production
            let apiHost;
            if (window.location.hostname === 'dev.gmai.sa') {
                // Production: use api.gmai.sa subdomain
                apiHost = 'api.gmai.sa';
            } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Development: use localhost with port
                apiHost = 'localhost:8000';
            } else {
                // Fallback: use same hostname with port 8000
                apiHost = `${window.location.hostname}:8000`;
            }
            
            // Build SIMPLIFIED query parameters - rely on server-side voice-optimized defaults
            const params = new URLSearchParams({
                // Essential parameters only
                preset: document.getElementById('preset-select').value || 'qwen_optimized',
                session_id: `browser_${Date.now()}`,
                
                // Only include non-default settings to keep URL clean
                ...(document.getElementById('language-select').value !== 'auto' && {
                    input_language: document.getElementById('language-select').value,
                    output_language: document.getElementById('language-select').value
                }),
                ...(document.getElementById('voice-select').value !== 'female' && {
                    speaker_voice: document.getElementById('voice-select').value
                }),
                ...(document.getElementById('emotion-select').value !== 'neutral' && {
                    emotion: document.getElementById('emotion-select').value
                }),
                ...(document.getElementById('speed-range').value !== '1.0' && {
                    speech_speed: document.getElementById('speed-range').value
                }),
                ...(document.getElementById('thinking-mode').value === 'true' && {
                    thinking_mode: 'true'
                })
            });
            
            return `${protocol}//${apiHost}/ws/voice-conversation?${params.toString()}`;
        }

        function connectWebSocket() {
            if (isConnected) {
                disconnectWebSocket();
                return;
            }

            const url = getWebSocketURL();
            addMessage('system', `Connecting to: ${url}`);
            
            websocket = new WebSocket(url);
            
            websocket.onopen = function(event) {
                isConnected = true;
                connectionStartTime = Date.now();
                updateConnectionStatus('connected');
                connectBtn.textContent = 'Disconnect';
                connectBtn.className = 'btn btn-danger';
                recordBtn.disabled = false;
                performanceStats.style.display = 'block';
                addMessage('system', 'Connected to BeautyAI! You can now start recording.');
                startConnectionTimer();
            };
            
            websocket.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                    addMessage('system', `Error: ${error.message}`);
                }
            };
            
            websocket.onclose = function(event) {
                isConnected = false;
                updateConnectionStatus('disconnected');
                connectBtn.textContent = 'Connect to BeautyAI';
                connectBtn.className = 'btn btn-primary';
                recordBtn.disabled = true;
                stopBtn.disabled = true;
                performanceStats.style.display = 'none';
                addMessage('system', `Connection closed: ${event.reason || 'Unknown reason'}`);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addMessage('system', 'Connection error occurred');
            };
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        function handleWebSocketMessage(message) {
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'connection_established':
                    addMessage('system', `Session established: ${message.session_id}`);
                    break;
                    
                case 'processing_started':
                    updateProcessingStatus('processing');
                    addMessage('system', 'Processing your voice message...');
                    break;
                    
                case 'voice_response':
                    updateProcessingStatus('idle');
                    
                    if (message.success) {
                        // Add transcription
                        if (message.transcription) {
                            addMessage('user', `üé§ "${message.transcription}"`);
                        }
                        
                        // Add AI response
                        if (message.response_text) {
                            addMessage('assistant', message.response_text);
                        }
                        
                        // Play audio response
                        if (message.audio_base64) {
                            playAudioResponse(message.audio_base64, message.audio_format || 'wav');
                        }
                        
                        // Update statistics
                        updatePerformanceStats(message);
                        sessionMessages++;
                        
                    } else {
                        addMessage('system', `Error: ${message.error}`);
                    }
                    break;
                    
                case 'pong':
                    // Handle ping response
                    break;
                    
                case 'config_updated':
                    addMessage('system', 'Settings updated successfully');
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                audioChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendAudioToServer(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                updateRecordingStatus('recording');
                recordBtn.textContent = '‚è∏Ô∏è Recording...';
                recordBtn.className = 'btn btn-danger';
                stopBtn.disabled = false;
                recordingIndicator.classList.add('active');
                
            } catch (error) {
                console.error('Error starting recording:', error);
                addMessage('system', `Recording error: ${error.message}`);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                recordingStream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                updateRecordingStatus('ready');
                recordBtn.textContent = 'üéôÔ∏è Start Recording';
                recordBtn.className = 'btn btn-success';
                stopBtn.disabled = true;
                recordingIndicator.classList.remove('active');
            }
        }

        function sendAudioToServer(audioBlob) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                addMessage('system', `Sending audio (${(audioBlob.size / 1024).toFixed(1)}KB) to BeautyAI...`);
                websocket.send(audioBlob);
            } else {
                addMessage('system', 'Error: Not connected to server');
            }
        }

        function playAudioResponse(audioBase64, format) {
            try {
                const audioBytes = atob(audioBase64);
                const audioArray = new Uint8Array(audioBytes.length);
                for (let i = 0; i < audioBytes.length; i++) {
                    audioArray[i] = audioBytes.charCodeAt(i);
                }
                
                const audioBlob = new Blob([audioArray], { type: `audio/${format}` });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                responseAudio.src = audioUrl;
                audioPlayer.style.display = 'block';
                responseAudio.play();
                
                // Clean up URL after playing
                responseAudio.addEventListener('ended', function() {
                    URL.revokeObjectURL(audioUrl);
                }, { once: true });
                
            } catch (error) {
                console.error('Error playing audio response:', error);
                addMessage('system', `Audio playback error: ${error.message}`);
            }
        }

        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const timePrefix = `[${timestamp}] `;
            
            messageDiv.innerHTML = `${timePrefix}${content}`;
            conversationLog.appendChild(messageDiv);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function clearConversation() {
            conversationLog.innerHTML = '<div class="message system">Conversation cleared.</div>';
            sessionMessages = 0;
            updatePerformanceStats({});
        }

        function updateConnectionStatus(status) {
            const statusCard = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            if (status === 'connected') {
                statusCard.className = 'status-card connected';
                statusText.textContent = 'Connected';
            } else {
                statusCard.className = 'status-card disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        function updateRecordingStatus(status) {
            const statusText = document.getElementById('recording-text');
            const statusCard = document.getElementById('recording-status');
            
            if (status === 'recording') {
                statusText.textContent = 'Recording...';
                statusCard.className = 'status-card connected';
            } else {
                statusText.textContent = 'Ready';
                statusCard.className = 'status-card';
            }
        }

        function updateProcessingStatus(status) {
            const statusText = document.getElementById('processing-text');
            const statusCard = document.getElementById('processing-status');
            
            if (status === 'processing') {
                statusText.textContent = 'Processing...';
                statusCard.className = 'status-card connected';
            } else {
                statusText.textContent = 'Idle';
                statusCard.className = 'status-card';
            }
        }

        function updatePerformanceStats(data) {
            if (data.processing_time_ms) {
                document.getElementById('processing-time').textContent = `${data.processing_time_ms.toFixed(0)}ms`;
            }
            
            if (data.audio_size_bytes) {
                document.getElementById('audio-size').textContent = `${(data.audio_size_bytes / 1024).toFixed(1)}KB`;
            }
            
            document.getElementById('session-messages').textContent = sessionMessages;
        }

        function startConnectionTimer() {
            setInterval(() => {
                if (isConnected && connectionStartTime) {
                    const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                    document.getElementById('connection-time').textContent = `${elapsed}s`;
                }
            }, 1000);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            addMessage('system', 'BeautyAI Voice Chat loaded. Click "Connect to BeautyAI" to begin.');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
