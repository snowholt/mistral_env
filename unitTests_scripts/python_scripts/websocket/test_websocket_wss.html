<!DOCTYPE html>
<html>
<head>
    <title>üîç WebSocket WSS Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .test-panel { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeaa7; 
        }
        .code { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            font-family: monospace; 
            margin: 10px 0; 
            white-space: pre-wrap; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #0056b3; 
        }
        .disabled { 
            background: #6c757d !important; 
            cursor: not-allowed; 
        }
        #results { 
            margin-top: 20px; 
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üîç WebSocket WSS Configuration Test</h1>
    
    <div class="test-panel">
        <h2>Environment Detection</h2>
        <div id="environment-info"></div>
    </div>
    
    <div class="grid">
        <div class="test-panel">
            <h3>üîí Production WSS Test</h3>
            <p>Test secure WebSocket connection to production endpoint</p>
            <button onclick="testProductionWSS()">Test WSS Connection</button>
            <div id="wss-results"></div>
        </div>
        
        <div class="test-panel">
            <h3>üè† Development WS Test</h3>
            <p>Test local WebSocket connection (development)</p>
            <button onclick="testDevelopmentWS()">Test WS Connection</button>
            <div id="ws-results"></div>
        </div>
    </div>
    
    <div class="test-panel">
        <h2>üß™ WebSocket Voice Manager Test</h2>
        <p>Test the actual WebSocket voice manager implementation</p>
        <button onclick="testVoiceManager()">Test Voice Manager</button>
        <button onclick="loadMainUI()" class="info">Load Main UI Scripts</button>
        <div id="voice-manager-results"></div>
    </div>
    
    <div class="test-panel">
        <h2>üìã Configuration Summary</h2>
        <div id="config-summary"></div>
    </div>
    
    <script>
        // Environment detection
        function detectEnvironment() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            
            const env = {
                hostname,
                protocol,
                port,
                isHTTPS: protocol === 'https:',
                isLocalhost: hostname === 'localhost' || hostname === '127.0.0.1',
                isProduction: hostname.includes('gmai.sa'),
                shouldUseWSS: protocol === 'https:' || hostname.includes('gmai.sa')
            };
            
            return env;
        }
        
        // Display environment info
        function displayEnvironment() {
            const env = detectEnvironment();
            const envDiv = document.getElementById('environment-info');
            
            const status = env.shouldUseWSS ? 'should use WSS' : 'should use WS';
            const statusClass = env.shouldUseWSS ? 'success' : 'info';
            
            envDiv.innerHTML = `
                <div class="status ${statusClass}">
                    <h4>Current Environment</h4>
                    <div class="code">Hostname: ${env.hostname}
Protocol: ${env.protocol}
Port: ${env.port || 'default'}
Is HTTPS: ${env.isHTTPS}
Is Localhost: ${env.isLocalhost}
Is Production: ${env.isProduction}
WebSocket Type: ${status}</div>
                </div>
            `;
        }
        
        // Test production WSS connection
        function testProductionWSS() {
            const resultsDiv = document.getElementById('wss-results');
            const wsUrl = 'wss://api.gmai.sa/ws/voice-conversation?test=true';
            
            resultsDiv.innerHTML = `
                <div class="status info">
                    <h4>Testing WSS Connection...</h4>
                    <div class="code">URL: ${wsUrl}</div>
                </div>
            `;
            
            const ws = new WebSocket(wsUrl);
            const startTime = Date.now();
            let pongReceived = false;
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'pong') {
                        pongReceived = true;
                        const currentContent = resultsDiv.innerHTML;
                        resultsDiv.innerHTML = currentContent.replace(
                            '</div>',
                            `
Pong received: ${JSON.stringify(data)}
‚úÖ Ping-Pong test successful!</div>`
                        );
                    } else if (data.type === 'connection_established') {
                        const currentContent = resultsDiv.innerHTML;
                        resultsDiv.innerHTML = currentContent.replace(
                            '</div>',
                            `
Connection confirmed: ${data.session_id}</div>`
                        );
                    }
                } catch (e) {
                    console.log('Non-JSON message received:', event.data);
                }
            };
            
            ws.onopen = function() {
                const duration = Date.now() - startTime;
                
                // Send a ping message to test the connection
                const pingMessage = {
                    type: "ping",
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(pingMessage));
                
                resultsDiv.innerHTML = `
                    <div class="status success">
                        <h4>‚úÖ WSS Connection Successful!</h4>
                        <div class="code">Connected to: ${wsUrl}
Connection time: ${duration}ms
WebSocket state: ${ws.readyState} (OPEN)
Protocol: ${ws.protocol || 'none'}
Ping sent: ${JSON.stringify(pingMessage)}</div>
                    </div>
                `;
                
                // Wait for pong response, then close
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close(1000, "Test completed");
                    }
                }, 2000);
            };
            
            ws.onerror = function(error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <h4>‚ùå WSS Connection Failed</h4>
                        <div class="code">Error connecting to: ${wsUrl}
Error details: ${error.type || 'Unknown error'}

Possible causes:
‚Ä¢ SSL certificate issues
‚Ä¢ nginx not proxying /ws/ correctly
‚Ä¢ BeautyAI API server not running on port 8000
‚Ä¢ Firewall blocking WSS connections</div>
                    </div>
                `;
            };
            
            ws.onclose = function(event) {
                if (event.code !== 1000) { // Not normal closure
                    const duration = Date.now() - startTime;
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <h4>‚ùå WSS Connection Closed</h4>
                            <div class="code">URL: ${wsUrl}
Close code: ${event.code}
Close reason: ${event.reason || 'No reason provided'}
Duration: ${duration}ms
Was clean: ${event.wasClean}

Common close codes:
‚Ä¢ 1006: Abnormal closure (connection lost)
‚Ä¢ 1015: TLS handshake failure
‚Ä¢ 1011: Server error</div>
                        </div>
                    `;
                }
            };
            
            // Timeout after 10 seconds
            setTimeout(() => {
                if (ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <h4>‚è∞ WSS Connection Timeout</h4>
                            <div class="code">Failed to connect within 10 seconds
URL: ${wsUrl}

This usually indicates:
‚Ä¢ Server not responding
‚Ä¢ Network connectivity issues
‚Ä¢ nginx proxy configuration problems</div>
                        </div>
                    `;
                }
            }, 10000);
        }
        
        // Test development WS connection
        function testDevelopmentWS() {
            const resultsDiv = document.getElementById('ws-results');
            const wsUrl = 'ws://localhost:8000/ws/voice-conversation?test=true';
            
            resultsDiv.innerHTML = `
                <div class="status info">
                    <h4>Testing WS Connection...</h4>
                    <div class="code">URL: ${wsUrl}</div>
                </div>
            `;
            
            const ws = new WebSocket(wsUrl);
            const startTime = Date.now();
            let pongReceived = false;
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'pong') {
                        pongReceived = true;
                        const currentContent = resultsDiv.innerHTML;
                        resultsDiv.innerHTML = currentContent.replace(
                            '</div>',
                            `
Pong received: ${JSON.stringify(data)}
‚úÖ Ping-Pong test successful!</div>`
                        );
                    } else if (data.type === 'connection_established') {
                        const currentContent = resultsDiv.innerHTML;
                        resultsDiv.innerHTML = currentContent.replace(
                            '</div>',
                            `
Connection confirmed: ${data.session_id}</div>`
                        );
                    }
                } catch (e) {
                    console.log('Non-JSON message received:', event.data);
                }
            };
            
            ws.onopen = function() {
                const duration = Date.now() - startTime;
                
                // Send a ping message to test the connection
                const pingMessage = {
                    type: "ping",
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(pingMessage));
                
                resultsDiv.innerHTML = `
                    <div class="status success">
                        <h4>‚úÖ WS Connection Successful!</h4>
                        <div class="code">Connected to: ${wsUrl}
Connection time: ${duration}ms
WebSocket state: ${ws.readyState} (OPEN)
Ping sent: ${JSON.stringify(pingMessage)}</div>
                    </div>
                `;
                
                // Wait for pong response, then close
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close(1000, "Test completed");
                    }
                }, 2000);
            };
            
            ws.onerror = function(error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <h4>‚ùå WS Connection Failed</h4>
                        <div class="code">Error connecting to: ${wsUrl}
Error details: ${error.type || 'Unknown error'}

Possible causes:
‚Ä¢ BeautyAI API server not running on localhost:8000
‚Ä¢ WebSocket endpoint not available
‚Ä¢ Port 8000 blocked or in use by another service</div>
                    </div>
                `;
            };
            
            ws.onclose = function(event) {
                if (event.code !== 1000) {
                    const duration = Date.now() - startTime;
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <h4>‚ùå WS Connection Closed</h4>
                            <div class="code">URL: ${wsUrl}
Close code: ${event.code}
Close reason: ${event.reason || 'No reason provided'}
Duration: ${duration}ms</div>
                        </div>
                    `;
                }
            };
            
            // Timeout after 5 seconds (local should be faster)
            setTimeout(() => {
                if (ws.readyState === WebSocket.CONNECTING) {
                    ws.close();
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <h4>‚è∞ WS Connection Timeout</h4>
                            <div class="code">Failed to connect within 5 seconds
URL: ${wsUrl}

Check if BeautyAI API server is running:
‚Ä¢ Run: curl http://localhost:8000/health
‚Ä¢ Check if port 8000 is listening</div>
                        </div>
                    `;
                }
            }, 5000);
        }
        
        // Load main UI scripts
        function loadMainUI() {
            const script = document.createElement('script');
            script.src = '/static/js/websocket-voice.js';
            script.onload = function() {
                console.log('‚úÖ WebSocket voice script loaded');
                document.getElementById('voice-manager-results').innerHTML = `
                    <div class="status success">
                        <h4>‚úÖ Scripts Loaded</h4>
                        <p>WebSocket voice manager is now available. Try the test below.</p>
                    </div>
                `;
            };
            script.onerror = function() {
                document.getElementById('voice-manager-results').innerHTML = `
                    <div class="status error">
                        <h4>‚ùå Script Load Failed</h4>
                        <p>Failed to load WebSocket voice manager script.</p>
                    </div>
                `;
            };
            document.head.appendChild(script);
        }
        
        // Test voice manager implementation
        function testVoiceManager() {
            const resultsDiv = document.getElementById('voice-manager-results');
            
            if (typeof WebSocketVoiceManager === 'undefined') {
                resultsDiv.innerHTML = `
                    <div class="status warning">
                        <h4>‚ö†Ô∏è WebSocketVoiceManager Not Available</h4>
                        <p>Load the main UI scripts first, then try again.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const voiceManager = new WebSocketVoiceManager();
                const env = detectEnvironment();
                const expectedUrl = env.shouldUseWSS ? 
                    'wss://api.gmai.sa/ws/voice-conversation' : 
                    'ws://localhost:8000/ws/voice-conversation';
                
                const actualUrl = voiceManager.getWebSocketUrl();
                const urlMatches = actualUrl === expectedUrl;
                
                resultsDiv.innerHTML = `
                    <div class="status ${urlMatches ? 'success' : 'error'}">
                        <h4>${urlMatches ? '‚úÖ' : '‚ùå'} Voice Manager URL Test</h4>
                        <div class="code">Expected URL: ${expectedUrl}
Actual URL: ${actualUrl}
Environment: ${env.isProduction ? 'Production' : 'Development'}
Protocol: ${env.protocol}
Hostname: ${env.hostname}

URL Logic: ${urlMatches ? 'CORRECT' : 'INCORRECT'}</div>
                    </div>
                `;
                
                // Test validation
                const validation = voiceManager.validateWebSocketConnection();
                const validationDiv = document.createElement('div');
                validationDiv.className = `status ${validation.valid ? 'success' : 'error'}`;
                validationDiv.innerHTML = `
                    <h4>${validation.valid ? '‚úÖ' : '‚ùå'} WebSocket Validation</h4>
                    <div class="code">${validation.valid ? 
                        `Validation passed:
URL: ${validation.url}
Secure: ${validation.secure}` : 
                        `Validation failed:
Error: ${validation.error}
Suggestion: ${validation.suggestion}`
                    }</div>
                `;
                resultsDiv.appendChild(validationDiv);
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status error">
                        <h4>‚ùå Voice Manager Test Failed</h4>
                        <div class="code">Error: ${error.message}
Stack: ${error.stack}</div>
                    </div>
                `;
            }
        }
        
        // Generate configuration summary
        function generateConfigSummary() {
            const env = detectEnvironment();
            const summaryDiv = document.getElementById('config-summary');
            
            const expectedConfig = {
                nginx: {
                    httpsRedirect: 'HTTP ‚Üí HTTPS redirect enabled',
                    sslCerts: 'SSL certificates for dev.gmai.sa and api.gmai.sa',
                    wsProxy: 'WebSocket proxy: /ws/ ‚Üí http://localhost:8000',
                    wssSupport: 'WSS support enabled'
                },
                webUI: {
                    service: 'beautyai-webui.service running on port 5001',
                    environment: 'BEAUTYAI_WS_URL=wss://api.gmai.sa/ws/voice-conversation',
                    scripts: 'websocket-voice.js loaded in templates'
                },
                websocket: {
                    production: 'wss://api.gmai.sa/ws/voice-conversation',
                    development: 'ws://localhost:8000/ws/voice-conversation',
                    fallback: 'REST API (/inference/voice-to-voice)'
                }
            };
            
            const currentExpected = env.shouldUseWSS ? 
                expectedConfig.websocket.production : 
                expectedConfig.websocket.development;
            
            summaryDiv.innerHTML = `
                <div class="status info">
                    <h4>üìã Expected Configuration</h4>
                    <div class="code">Current Environment: ${env.isProduction ? 'Production (gmai.sa)' : 'Development (localhost)'}
Expected WebSocket: ${currentExpected}
SSL Required: ${env.shouldUseWSS ? 'Yes (WSS)' : 'No (WS)'}

‚úÖ Nginx Configuration:
   - HTTPS redirect: Enabled
   - SSL certificates: Configured
   - WebSocket proxy: /ws/ ‚Üí localhost:8000
   
‚úÖ Web UI Service:
   - Port: 5001 (behind nginx proxy)
   - Environment: Production mode
   - WebSocket scripts: Loaded
   
‚úÖ WebSocket Implementation:
   - Auto-detection: Hostname-based
   - Validation: SSL/WSS compatibility check
   - Fallback: REST API for voice-to-voice</div>
                </div>
            `;
        }
        
        // Initialize page
        window.onload = function() {
            displayEnvironment();
            generateConfigSummary();
            
            // Auto-test based on environment
            const env = detectEnvironment();
            if (env.shouldUseWSS) {
                console.log('üîí Production environment detected - testing WSS');
            } else {
                console.log('üè† Development environment detected - testing WS');
            }
        };
    </script>
</body>
</html>
